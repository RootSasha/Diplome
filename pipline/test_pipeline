#!/bin/bash

JENKINS_URL="http://192.168.0.113:8080"
JENKINS_USER="admin"
JENKINS_PASSWORD="1"  # üîπ –ö—Ä–∞—â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ API-—Ç–æ–∫–µ–Ω
CREDENTIAL_ID="ssh-key-jenkins"  # üîπ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π ID SSH-–∫–ª—é—á–∞
JOB_DIR="jenkins_jobs"
mkdir -p "$JOB_DIR"

CLI_JAR="jenkins-cli.jar"

# üîπ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è pipeline'—ñ–≤
declare -A pipelines=(
    ["grafana-monitoring"]="git@github.com:RootSasha/grafana.git"
    ["monitoring-site"]="git@github.com:RootSasha/diplome-site.git"
)

# üîπ –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∑–∞–ø—É—Å–∫—É –ø–∞–π–ø–ª–∞–π–Ω—ñ–≤
ordered_jobs=("grafana-monitoring" "monitoring-site")

# üîπ –°—Ç–≤–æ—Ä—é—î–º–æ pipeline –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
for job in "${ordered_jobs[@]}"; do
    REPO_URL="${pipelines[$job]}"

    echo "üöÄ –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–π–ø–ª–∞–π–Ω: $job (–¥–∂–µ—Ä–µ–ª–æ: $REPO_URL)..."

    # –®–ª—è—Ö –¥–æ XML-—Ñ–∞–π–ª—É
    JOB_XML="$JOB_DIR/$job.xml"

    cat <<EOF > "$JOB_XML"
<flow-definition plugin="workflow-job">
    <actions/>
    <description>Pipeline –¥–ª—è $job</description>
    <keepDependencies>false</keepDependencies>
    <properties/>
    <definition class="org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition">
        <scm class="hudson.plugins.git.GitSCM">
            <configVersion>2</configVersion>
            <userRemoteConfigs>
                <hudson.plugins.git.UserRemoteConfig>
                    <url>$REPO_URL</url>
                    <credentialsId>$CREDENTIAL_ID</credentialsId>
                </hudson.plugins.git.UserRemoteConfig>
            </userRemoteConfigs>
            <branches>
                <hudson.plugins.git.BranchSpec>
                    <name>*/main</name>
                </hudson.plugins.git.BranchSpec>
            </branches>
        </scm>
        <scriptPath>Jenkinsfile</scriptPath>
        <sandbox>true</sandbox>
    </definition>
    <triggers/>
</flow-definition>
EOF

    # üîπ –°—Ç–≤–æ—Ä—é—î–º–æ pipeline job —É Jenkins
    java -jar "$CLI_JAR" -s "$JENKINS_URL" -auth "$JENKINS_USER:$JENKINS_PASSWORD" create-job "$job" < "$JOB_XML"

    if [[ $? -eq 0 ]]; then
        echo "‚úÖ $job —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
    else
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è $job"
        exit 1  # –ó—É–ø–∏–Ω—è—î–º–æ —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    fi

    # üîπ –ó–∞–ø—É—Å–∫–∞—î–º–æ pipeline –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —á–µ–∫–∞—î–º–æ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
    echo "üèÉ –ó–∞–ø—É—Å–∫–∞—î–º–æ $job..."
    java -jar "$CLI_JAR" -s "$JENKINS_URL" -auth "$JENKINS_USER:$JENKINS_PASSWORD" build "$job" -s

    if [[ $? -eq 0 ]]; then
        echo "‚úÖ $job –≤–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
    else
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É $job"
        exit 1  # –ó—É–ø–∏–Ω—è—î–º–æ —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    fi

done

echo "üéâ –í—Å—ñ –ø–∞–π–ø–ª–∞–π–Ω–∏ —Å—Ç–≤–æ—Ä–µ–Ω–æ —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ!"
